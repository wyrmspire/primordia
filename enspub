#!/usr/bin/env bash
set -euo pipefail
EMULATOR_HOST="localhost:8083"
PROJECT_ID="ticktalk-472521"
TOPIC="primordia-builds"
SUB="primordia-local-launcher-sub"

echo "Ensuring Pub/Sub topic and subscription exist via REST API..."

# Create the Topic using curl
# The -s hides progress, -o /dev/null discards output, -w '%{http_code}' prints the status code
STATUS_TOPIC=$(curl -s -o /dev/null -w "%{http_code}" -X PUT "http://$EMULATOR_HOST/v1/projects/$PROJECT_ID/topics/$TOPIC")
echo " -> Topic creation attempt for '$TOPIC' returned status: $STATUS_TOPIC"

# Create the Subscription using curl
# We send a JSON payload to associate the subscription with the topic
STATUS_SUB=$(curl -s -o /dev/null -w "%{http_code}" -X PUT "http://$EMULATOR_HOST/v1/projects/$PROJECT_ID/subscriptions/$SUB" \
     -H "Content-Type: application/json" \
     -d "{\"topic\":\"projects/$PROJECT_ID/topics/$TOPIC\"}")
echo " -> Subscription creation attempt for '$SUB' returned status: $STATUS_SUB"

# Verify using curl (optional but good for debugging)
echo "Verifying resources..."
curl -s "http://$EMULATOR_HOST/v1/projects/$PROJECT_ID/subscriptions" | jq
echo "âœ… Pub/Sub REST commands sent."
