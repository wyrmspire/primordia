#!/usr/bin/env bash
set -euo pipefail
echo "[core] bringing up primordia, pubsub, gcs"

if [ -f docker-compose.proxy.override.yml ]; then
  docker compose \
    -f docker-compose.yml \
    -f docker-compose.override.yml \
    -f docker-compose.proxy.override.yml \
    up -d --no-deps gcs pubsub gcs-init primordia local-launcher
else
  docker compose up -d --no-deps gcs pubsub gcs-init primordia local-launcher
fi

echo "[core] waiting for /healthz"
for i in {1..40}; do
  if curl -fsS http://localhost:8080/healthz >/dev/null 2>&1; then
    echo "[core] ✅ primordia healthy"
    break
  fi
  sleep 0.5
  if [ "$i" -eq 40 ]; then
    echo "[core] ❌ primordia not ready after 20s"; exit 1
  fi
done

# show proxy env so we know allowlist is applied
docker exec -it primordia-primordia-1 env | grep -E '^PROXY_' || true
